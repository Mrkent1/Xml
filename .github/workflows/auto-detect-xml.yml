name: Auto Detect XML Templates & Build EXE - Enhanced

on:
  push:
    paths:
      - 'original_templates/**/*.xml'
      - 'xml_templates/**/*.xml'
      - 'templates/**/*.xml'
      - '*.xml'
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even without XML changes'
        required: false
        default: 'false'
      platform:
        description: 'Platform to build for'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - windows
          - linux
          - macos

jobs:
  detect-xml:
    runs-on: ubuntu-latest
    outputs:
      has_xml_changes: ${{ steps.check-xml.outputs.has_changes }}
      xml_count: ${{ steps.check-xml.outputs.xml_count }}
      xml_files: ${{ steps.check-xml.outputs.xml_files }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Láº¥y toÃ n bá»™ lá»‹ch sá»­ Ä‘á»ƒ so sÃ¡nh
    
    - name: Check XML changes
      id: check-xml
      run: |
        echo "ğŸ” Kiá»ƒm tra thay Ä‘á»•i file XML..."
        
        # Láº¥y danh sÃ¡ch file XML hiá»‡n táº¡i
        CURRENT_XML=$(find . -name "*.xml" -type f | grep -E "(original_templates|xml_templates|templates)" | sort)
        echo "ğŸ“ File XML hiá»‡n táº¡i:"
        echo "$CURRENT_XML"
        
        # Äáº¿m sá»‘ file XML
        XML_COUNT=$(echo "$CURRENT_XML" | wc -l)
        echo "ğŸ“Š Tá»•ng sá»‘ file XML: $XML_COUNT"
        
        # Kiá»ƒm tra thay Ä‘á»•i so vá»›i commit trÆ°á»›c
        if [ "${{ github.event_name }}" = "push" ]; then
          PREV_COMMIT="${{ github.event.before }}"
          CURRENT_COMMIT="${{ github.sha }}"
          
          echo "ğŸ”„ So sÃ¡nh commit: $PREV_COMMIT -> $CURRENT_COMMIT"
          
          # Láº¥y file XML Ä‘Ã£ thay Ä‘á»•i
          CHANGED_XML=$(git diff --name-only $PREV_COMMIT $CURRENT_COMMIT | grep "\.xml$" | grep -E "(original_templates|xml_templates|templates)")
          
          if [ -n "$CHANGED_XML" ]; then
            echo "âœ… PhÃ¡t hiá»‡n thay Ä‘á»•i file XML:"
            echo "$CHANGED_XML"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ KhÃ´ng cÃ³ thay Ä‘á»•i file XML"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "ğŸ”„ Manual trigger - bá» qua kiá»ƒm tra thay Ä‘á»•i"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
        
        echo "xml_count=$XML_COUNT" >> $GITHUB_OUTPUT
        echo "xml_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CURRENT_XML" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "âœ… HoÃ n táº¥t kiá»ƒm tra XML!"
    
    - name: Show XML info
      run: |
        echo "ğŸ“Š THÃ”NG TIN XML PHÃT HIá»†N:"
        echo "CÃ³ thay Ä‘á»•i: ${{ steps.check-xml.outputs.has_xml_changes }}"
        echo "Sá»‘ file: ${{ steps.check-xml.outputs.xml_count }}"
        echo "Danh sÃ¡ch file:"
        echo "${{ steps.check-xml.outputs.xml_files }}"

  build-exe:
    needs: detect-xml
    if: needs.detect-xml.outputs.has_xml_changes == 'true' || github.event.inputs.force_build == 'true'
    strategy:
      matrix:
        platform: ${{ github.event.inputs.platform == 'all' && fromJSON('["windows", "linux", "macos"]') || fromJSON('["' + github.event.inputs.platform + '"]') }}
    
    runs-on: ${{ matrix.platform }}-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install customtkinter
        pip install watchdog
        pip install requests
        pip install psutil
    
    - name: Prepare templates directory
      shell: pwsh
      if: matrix.platform == 'windows'
      run: |
        Write-Host "ğŸ“ Chuáº©n bá»‹ thÆ° má»¥c templates..."
        
        # Táº¡o thÆ° má»¥c templates náº¿u chÆ°a cÃ³
        if (!(Test-Path "templates")) {
          New-Item -ItemType Directory -Path "templates" -Force
        }
        
        # Copy táº¥t cáº£ file XML gá»‘c vÃ o templates
        Write-Host "ğŸ“‹ Copy file XML gá»‘c vÃ o templates..."
        
        # Copy tá»« original_templates
        if (Test-Path "original_templates") {
          Write-Host "ğŸ“ Copy tá»« original_templates..."
          Copy-Item "original_templates\*.xml" -Destination "templates\" -Force
        }
        
        # Copy tá»« xml_templates
        if (Test-Path "xml_templates") {
          Write-Host "ğŸ“ Copy tá»« xml_templates..."
          Copy-Item "xml_templates\*.xml" -Destination "templates\" -Force
        }
        
        # Copy file XML trá»±c tiáº¿p
        Write-Host "ğŸ“„ Copy file XML trá»±c tiáº¿p..."
        Get-ChildItem -Path "." -Filter "*.xml" -MaxDepth 1 | Copy-Item -Destination "templates\" -Force
        
        # Hiá»ƒn thá»‹ ná»™i dung templates
        Write-Host "ğŸ“‹ Ná»™i dung thÆ° má»¥c templates:"
        Get-ChildItem "templates\" | Format-Table Name, Length
        
        # Äáº¿m file XML
        $XML_COUNT = (Get-ChildItem "templates\" -Filter "*.xml").Count
        Write-Host "ğŸ“Š Tá»•ng sá»‘ file XML trong templates: $XML_COUNT"
    
    - name: Prepare templates directory (Unix)
      if: matrix.platform != 'windows'
      run: |
        echo "ğŸ“ Chuáº©n bá»‹ thÆ° má»¥c templates..."
        
        # Táº¡o thÆ° má»¥c templates náº¿u chÆ°a cÃ³
        mkdir -p templates
        
        # Copy táº¥t cáº£ file XML gá»‘c vÃ o templates
        echo "ğŸ“‹ Copy file XML gá»‘c vÃ o templates..."
        
        # Copy tá»« original_templates
        if [ -d "original_templates" ]; then
          echo "ğŸ“ Copy tá»« original_templates..."
          cp original_templates/*.xml templates/ 2>/dev/null || true
        fi
        
        # Copy tá»« xml_templates
        if [ -d "xml_templates" ]; then
          echo "ğŸ“ Copy tá»« xml_templates..."
          cp xml_templates/*.xml templates/ 2>/dev/null || true
        fi
        
        # Copy file XML trá»±c tiáº¿p
        echo "ğŸ“„ Copy file XML trá»±c tiáº¿p..."
        cp *.xml templates/ 2>/dev/null || true
        
        # Hiá»ƒn thá»‹ ná»™i dung templates
        echo "ğŸ“‹ Ná»™i dung thÆ° má»¥c templates:"
        ls -la templates/
        
        # Äáº¿m file XML
        XML_COUNT=$(find templates/ -name "*.xml" | wc -l)
        echo "ğŸ“Š Tá»•ng sá»‘ file XML trong templates: $XML_COUNT"
    
    - name: Build EXE with PyInstaller
      run: |
        echo "ğŸš€ Báº¯t Ä‘áº§u build EXE cho platform: ${{ matrix.platform }}..."
        
        if [ "${{ matrix.platform }}" = "windows" ]; then
          pyinstaller --onefile --noconsole --add-data "templates;templates" --name "XMLProcessor-Windows" icon3.py
        elif [ "${{ matrix.platform }}" = "linux" ]; then
          pyinstaller --onefile --add-data "templates:templates" --name "XMLProcessor-Linux" icon3.py
        elif [ "${{ matrix.platform }}" = "macos" ]; then
          pyinstaller --onefile --add-data "templates:templates" --name "XMLProcessor-MacOS" icon3.py
        fi
        
        echo "âœ… Build EXE hoÃ n táº¥t cho ${{ matrix.platform }}!"
        echo "ğŸ“ Kiá»ƒm tra káº¿t quáº£:"
        ls -la dist/
    
    - name: Upload EXE artifact
      uses: actions/upload-artifact@v4
      with:
        name: XMLProcessor-${{ matrix.platform }}-EXE
        path: dist/XMLProcessor-${{ matrix.platform }}*
    
    - name: Create Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/XMLProcessor-${{ matrix.platform }}*
        tag_name: v${{ github.run_number }}-${{ matrix.platform }}-auto
        name: Release v${{ github.run_number }} - ${{ matrix.platform }} - Auto XML Detection
        body: |
          ğŸš€ **XMLProcessor EXE Build - ${{ matrix.platform }} - Tá»± Ä‘á»™ng nháº­n diá»‡n XML**
          
          **Build Info:**
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref }}
          - Build Number: ${{ github.run_number }}
          - Platform: ${{ matrix.platform }}
          - XML Files: ${{ needs.detect-xml.outputs.xml_count }}
          
          **XML Files Detected:**
          ```
          ${{ needs.detect-xml.outputs.xml_files }}
          ```
          
          **Features:**
          - âœ… Multi-platform support (${{ matrix.platform }})
          - âœ… Smart versioning
          - âœ… Templates included (Auto-detected)
          - âœ… Smart XML overwrite
          - âœ… Telegram bot integration
          - âœ… Machine Management System
          
          **Download:**
          - Platform: `${{ matrix.platform }}`
          - Files: See artifacts above
          
          **Auto-detection:**
          - ğŸ” Tá»± Ä‘á»™ng nháº­n diá»‡n file XML gá»‘c
          - ğŸ“ Tá»± Ä‘á»™ng copy vÃ o templates
          - ğŸš€ Tá»± Ä‘á»™ng build khi cÃ³ thay Ä‘á»•i XML
          
          **Machine Management:**
          - ğŸ¤– Auto Machine ID generation
          - ğŸ“Š Real-time monitoring
          - âš¡ Batch operations
          - ğŸ¥ Health check automation

  notify-telegram:
    needs: [detect-xml, build-exe]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Notify Telegram
      run: |
        echo "ğŸ“± Gá»­i thÃ´ng bÃ¡o Telegram..."
        
        # ThÃ´ng bÃ¡o káº¿t quáº£ build
        if [ "${{ needs.build-exe.result }}" = "success" ]; then
          echo "ğŸ‰ BUILD THÃ€NH CÃ”NG!"
          echo "ğŸ“Š XML Files: ${{ needs.detect-xml.outputs.xml_count }}"
          echo "ğŸ“ Files: ${{ needs.detect-xml.outputs.xml_files }}"
          echo "ğŸ¤– Machine Management System: ENABLED"
        else
          echo "âŒ BUILD THáº¤T Báº I!"
        fi
        
        echo "âœ… HoÃ n táº¥t thÃ´ng bÃ¡o!"
